name: Publish SDKs

on:
  push:
    tags:
      - "sdk-v*"
      - "widget-v*"
      - "python-v*"
      - "fm-v*"
      - "fmctl-v*"
  workflow_dispatch:
    inputs:
      package:
        description: "Package to publish"
        required: true
        type: choice
        options:
          - all
          - sdk
          - widget
          - python
          - fm
          - fmctl
      dry_run:
        description: "Dry run (no actual publish)"
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: "22"
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # DETERMINE WHICH PACKAGES TO PUBLISH
  # ============================================================================
  determine-packages:
    name: Determine packages
    runs-on: ubuntu-latest
    outputs:
      publish_sdk: ${{ steps.set-packages.outputs.publish_sdk }}
      publish_widget: ${{ steps.set-packages.outputs.publish_widget }}
      publish_python: ${{ steps.set-packages.outputs.publish_python }}
      publish_fm: ${{ steps.set-packages.outputs.publish_fm }}
      publish_fmctl: ${{ steps.set-packages.outputs.publish_fmctl }}
    steps:
      - name: Set packages to publish
        id: set-packages
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PACKAGE="${{ github.event.inputs.package }}"
            if [[ "$PACKAGE" == "all" ]]; then
              echo "publish_sdk=true" >> $GITHUB_OUTPUT
              echo "publish_widget=true" >> $GITHUB_OUTPUT
              echo "publish_python=true" >> $GITHUB_OUTPUT
              echo "publish_fm=true" >> $GITHUB_OUTPUT
              echo "publish_fmctl=true" >> $GITHUB_OUTPUT
            else
              echo "publish_sdk=$([[ '$PACKAGE' == 'sdk' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
              echo "publish_widget=$([[ '$PACKAGE' == 'widget' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
              echo "publish_python=$([[ '$PACKAGE' == 'python' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
              echo "publish_fm=$([[ '$PACKAGE' == 'fm' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
              echo "publish_fmctl=$([[ '$PACKAGE' == 'fmctl' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            fi
          else
            # Tag-based publishing
            TAG="${{ github.ref_name }}"
            echo "publish_sdk=$([[ '$TAG' == sdk-v* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "publish_widget=$([[ '$TAG' == widget-v* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "publish_python=$([[ '$TAG' == python-v* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "publish_fm=$([[ '$TAG' == fm-v* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "publish_fmctl=$([[ '$TAG' == fmctl-v* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # BUILD AND TEST NPM PACKAGES
  # ============================================================================
  build-npm:
    name: Build npm packages
    runs-on: ubuntu-latest
    needs: determine-packages
    if: needs.determine-packages.outputs.publish_sdk == 'true' || needs.determine-packages.outputs.publish_widget == 'true' || needs.determine-packages.outputs.publish_fm == 'true' || needs.determine-packages.outputs.publish_fmctl == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build @flowmaestro/sdk
        if: needs.determine-packages.outputs.publish_sdk == 'true'
        run: npm run build --workspace=@flowmaestro/sdk

      - name: Build @flowmaestro/widget
        if: needs.determine-packages.outputs.publish_widget == 'true'
        run: npm run build --workspace=@flowmaestro/widget

      - name: Type check @flowmaestro/sdk
        if: needs.determine-packages.outputs.publish_sdk == 'true'
        run: npm run typecheck --workspace=@flowmaestro/sdk

      - name: Type check @flowmaestro/widget
        if: needs.determine-packages.outputs.publish_widget == 'true'
        run: npm run typecheck --workspace=@flowmaestro/widget

      - name: Build @flowmaestro/cli
        if: needs.determine-packages.outputs.publish_fm == 'true'
        run: npm run build --workspace=@flowmaestro/cli

      - name: Type check @flowmaestro/cli
        if: needs.determine-packages.outputs.publish_fm == 'true'
        run: npm run typecheck --workspace=@flowmaestro/cli

      - name: Build @flowmaestro/deploy-cli
        if: needs.determine-packages.outputs.publish_fmctl == 'true'
        run: npm run build --workspace=@flowmaestro/deploy-cli

      - name: Type check @flowmaestro/deploy-cli
        if: needs.determine-packages.outputs.publish_fmctl == 'true'
        run: npm run typecheck --workspace=@flowmaestro/deploy-cli

  # ============================================================================
  # PUBLISH NPM PACKAGES
  # ============================================================================
  publish-sdk:
    name: Publish @flowmaestro/sdk
    runs-on: ubuntu-latest
    needs: [determine-packages, build-npm]
    if: needs.determine-packages.outputs.publish_sdk == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@flowmaestro/sdk

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: npm publish --workspace=@flowmaestro/sdk --access public --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish
        if: github.event.inputs.dry_run != 'true'
        run: npm publish --workspace=@flowmaestro/sdk --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-widget:
    name: Publish @flowmaestro/widget
    runs-on: ubuntu-latest
    needs: [determine-packages, build-npm]
    if: needs.determine-packages.outputs.publish_widget == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@flowmaestro/widget

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: npm publish --workspace=@flowmaestro/widget --access public --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish
        if: github.event.inputs.dry_run != 'true'
        run: npm publish --workspace=@flowmaestro/widget --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-fm:
    name: Publish @flowmaestro/cli (public)
    runs-on: ubuntu-latest
    needs: [determine-packages, build-npm]
    if: needs.determine-packages.outputs.publish_fm == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@flowmaestro/cli

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: npm publish --workspace=@flowmaestro/cli --access public --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish
        if: github.event.inputs.dry_run != 'true'
        run: npm publish --workspace=@flowmaestro/cli --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-fmctl:
    name: Publish @flowmaestro/deploy-cli (private)
    runs-on: ubuntu-latest
    needs: [determine-packages, build-npm]
    if: needs.determine-packages.outputs.publish_fmctl == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@flowmaestro/deploy-cli

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: npm publish --workspace=@flowmaestro/deploy-cli --access restricted --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish
        if: github.event.inputs.dry_run != 'true'
        run: npm publish --workspace=@flowmaestro/deploy-cli --access restricted
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================================
  # PUBLISH PYTHON PACKAGE
  # ============================================================================
  publish-python:
    name: Publish flowmaestro (PyPI)
    runs-on: ubuntu-latest
    needs: determine-packages
    if: needs.determine-packages.outputs.publish_python == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        working-directory: sdks/python
        run: python -m build

      - name: Check package
        working-directory: sdks/python
        run: twine check dist/*

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: sdks/python
        run: |
          echo "Dry run - would publish:"
          ls -la dist/

      - name: Publish to PyPI
        if: github.event.inputs.dry_run != 'true'
        working-directory: sdks/python
        run: twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
