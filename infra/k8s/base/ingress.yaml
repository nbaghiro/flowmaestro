apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: flowmaestro-cert
  namespace: flowmaestro
spec:
  domains:
    - api.flowmaestro.ai
    - app.flowmaestro.ai
    - www.flowmaestro.ai
    - blog.flowmaestro.ai
    - docs.flowmaestro.ai
    - static.flowmaestro.ai
    - flowmaestro.ai

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: flowmaestro-ingress
  namespace: flowmaestro
  annotations:
    # Use Google Cloud Load Balancer
    kubernetes.io/ingress.class: "gce"

    # Use global static IP
    kubernetes.io/ingress.global-static-ip-name: "flowmaestro-static-ip"

    # Enable managed SSL certificate
    networking.gke.io/managed-certificates: "flowmaestro-cert"

    # Redirect HTTP to HTTPS
    kubernetes.io/ingress.allow-http: "true"
spec:
  rules:
    # API server
    - host: api.flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: api-service
                port:
                  number: 3001

    # Frontend app (served from Kubernetes)
    - host: app.flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

    # Marketing site (www subdomain)
    - host: www.flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: marketing-service
                port:
                  number: 80

    # Marketing site (root domain)
    - host: flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: marketing-service
                port:
                  number: 80

    # Blog subdomain (served from marketing SPA)
    - host: blog.flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: marketing-service
                port:
                  number: 80

    # Documentation site
    - host: docs.flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: documentation-service
                port:
                  number: 80

    # Static assets (widget JS, etc.)
    - host: static.flowmaestro.ai
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: static-service
                port:
                  number: 80

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-server-network-policy
  namespace: flowmaestro
spec:
  podSelector:
    matchLabels:
      app: flowmaestro
      component: api-server
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from within the cluster (other pods/namespaces)
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 3001
    # Allow GCP Load Balancer health check probes
    - from:
        - ipBlock:
            cidr: 130.211.0.0/22
        - ipBlock:
            cidr: 35.191.0.0/16
      ports:
        - protocol: TCP
          port: 3001
  egress:
    # Allow DNS (both internal and external)
    - ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS for external APIs (OAuth providers, etc.)
    - ports:
        - protocol: TCP
          port: 443
    # Allow PostgreSQL
    - ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - ports:
        - protocol: TCP
          port: 6379
    # Allow Temporal
    - ports:
        - protocol: TCP
          port: 7233

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: temporal-worker-network-policy
  namespace: flowmaestro
spec:
  podSelector:
    matchLabels:
      app: flowmaestro
      component: temporal-worker
  policyTypes:
    - Egress
  egress:
    # Allow DNS (both internal and external)
    - ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS for external APIs (OpenAI, Anthropic, etc.)
    - ports:
        - protocol: TCP
          port: 443
    # Allow PostgreSQL
    - ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - ports:
        - protocol: TCP
          port: 6379
    # Allow Temporal
    - ports:
        - protocol: TCP
          port: 7233
